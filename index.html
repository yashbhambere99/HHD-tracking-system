<!DOCTYPE html>
<html>
<head>
<title>HDD Repair Tracking</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>

.error {
  border: 2px solid red !important;
}

body {font-family: Arial; background:#f4f6f9; margin:0;}
.container {max-width:1100px; width:95%; margin:20px auto; background:white; padding:25px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1);}
.row {display:flex; gap:15px; margin-bottom:10px; flex-wrap:wrap; align-items:center;}
.col {flex:1; min-width:200px;}
input,select,button {padding:8px; width:100%; box-sizing:border-box;}
button {background:#2c7be5; color:white; border:none; cursor:pointer; margin-top:10px;}
button:hover {background:#1a68d1;}
button:disabled {background:#999; cursor:not-allowed;}
.removeBtn {background:#dc3545; padding:8px 12px; width:auto;}
.removeBtn:hover {background:#b02a37;}
.hidden {display:none;}
table {width:100%; border-collapse:collapse; margin-top:20px;}
th,td {border:1px solid #ddd; padding:8px; text-align:left;}
th {background:#2c7be5; color:white;}
@media(max-width:768px){.row {flex-direction:column; align-items:stretch;} .removeBtn {width:100%;}}
</style>
</head>
<body>

<div class="container">

<h2>HDD Repair Tracking System</h2>

<select id="mode" onchange="switchMode()">
  <option value="dispatch">Dispatch to Service Centre</option>
  <option value="receive">Receive After Repair</option>
</select>

<!-- ================= DISPATCH SECTION ================= -->
<div id="dispatchSection">

<div class="row">
  <div class="col">
    <select id="region">
      <option value="">Select Region</option>
      <option value="North">North</option>
      <option value="South">South</option>
      <option value="East">East</option>
      <option value="West">West</option>
    </select>
  </div>
  <div class="col">
    <select id="make">
      <option value="">Select Make</option>
      <option value="Urovo">Urovo</option>
      <option value="Newland">Newland</option>
    </select>
  </div>
  <div class="col"><input type="text" id="model" placeholder="Model"></div>
</div>

<!-- Case ID / RMA -->
<div class="row">
  <div class="col"><input type="text" id="caseId" placeholder=" RMA Number " disabled></div>
</div>

<div id="serialContainer"></div>
<button type="button" onclick="addSerial()">Add Serial Number</button>

<div class="row">
  <div class="col"><input type="text" id="locationName" placeholder="Location Name"></div>
  <div class="col">
    <select id="facilityEntity">
      <option value="">Select Facility Entity</option>
      <option value="WHS">WHS</option>
      <option value="CPC">CPC</option>
      <option value="HP">HP</option>
    </select>
  </div>
</div>

<div class="row">
  <div class="col"><input type="text" id="receivedMailSubject" placeholder="Received Mail Subject from Operations"></div>
  <div class="col"><input type="text"
       id="receivedDate"
       placeholder="Received Date from Operations"
       onclick="this.showPicker ? this.showPicker() : this.focus()"
       onfocus="this.type='date'; this.showPicker && this.showPicker()"
       onblur="if(!this.value)this.type='text'">
  </div>
</div>

<div class="row">
  <div class="col"><input type="text" id="dispatchMailSubject" placeholder="Dispatch Mail Subject"></div>
  <div class="col"><input type="text" id="dispatchDocket" placeholder="Dispatch Docket Number"></div>
</div>

<div class="row">
  <div class="col"><input type="text"
       id="dispatchDate"
       placeholder="Dispatch Date - Service Centre"
       onclick="this.showPicker ? this.showPicker() : this.focus()"
       onfocus="this.type='date'; this.showPicker && this.showPicker()"
       onblur="if(!this.value)this.type='text'">
  </div>
  <div class="col"><input type="text" id="dispatchCourier" placeholder="Dispatch Courier Partner Name"></div>
</div>

<button type="button" id="dispatchBtn" onclick="submitDispatch()">Submit Dispatch Details</button>

</div>

<!-- ================= RECEIVE SECTION ================= -->
<div id="receiveSection" class="hidden">

<input type="text" id="searchDispatch" placeholder="Enter Dispatch Mail Subject or Docket Number">
<button type="button" id="searchBtn" onclick="searchDispatch()">Search</button>

<div id="resultArea"></div>

<div class="row">
  <div class="col"><input type="text"
       id="receivedDatePostRepair"
       placeholder="Received Date Post Repair"
       onclick="this.showPicker ? this.showPicker() : this.focus()"
       onfocus="this.type='date'; this.showPicker && this.showPicker()"
       onblur="if(!this.value)this.type='text'">
  </div>
  <div class="col"><input type="text" id="receiveDocket" placeholder="Receive Docket Number"></div>
  <div class="col"><input type="text" id="receiveCourier" placeholder="Receive Courier Partner Name"></div>
</div>

<button type="button" id="receiveBtn" onclick="submitReceive()">Mark as Received</button>

</div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxuceQM7A5zGBeZoexD5QKK2CInGYomKe6XBMkURe3jIRFm8sAakDxwJ5BKbtCNnZRnBg/exec";

let selectedRows = [];

function validateField(field){
    if(!field.value || field.value.trim() === ""){
        field.classList.add("error");
        return false;
    } else {
        field.classList.remove("error");
        return true;
    }
}

function clearErrorOnInput(field){
    field.addEventListener("input", function(){
        if(field.value.trim() !== ""){
            field.classList.remove("error");
        }
    });
}


function switchMode(){
    let mode = document.getElementById("mode").value;
    dispatchSection.classList.toggle("hidden", mode !== "dispatch");
    receiveSection.classList.toggle("hidden", mode !== "receive");
}

// Add serial row
function addSerial(){
    let div = document.createElement("div");
    div.classList.add("row");
    div.innerHTML=`<div class="col"><input type="text" placeholder="Serial Number" class="serial"></div>
    <div class="col"><input type="text" placeholder="Identify Problem" class="problem"></div>
    <div><button type="button" class="removeBtn" onclick="removeSerial(this)">Remove</button></div>`;
    serialContainer.appendChild(div);
}
function removeSerial(btn){ btn.parentElement.parentElement.remove(); }

// ===== CASE ID / RMA based on Make =====
document.getElementById("make").addEventListener("change", function(){
    let make = this.value;
    let caseInput = document.getElementById("caseId");
    if(make === "Urovo"){
        caseInput.value = "Auto-generated";
        caseInput.disabled = true;
    } else if(make === "Newland"){
        caseInput.value = "";
        caseInput.disabled = false;
    } else {
        caseInput.value = "";
        caseInput.disabled = true;
    }
});

// ================= SEARCH =================
function searchDispatch(){
    let btn = document.getElementById("searchBtn");
    btn.disabled = true;
    btn.innerText = "Searching...";

    let searchValue = document.getElementById("searchDispatch").value.trim();
    if(!searchValue){
        alert("Please enter Dispatch Mail Subject or Docket Number");
        btn.disabled = false;
        btn.innerText = "Search";
        return;
    }

    fetch(WEB_APP_URL,{
        method:"POST",
        body:JSON.stringify({type:"searchDispatch", searchValue: searchValue})
    }).then(res => res.json()).then(data => {
        selectedRows = [];
        let html = "<table><tr><th>Select</th><th>Serial</th><th>Case ID</th><th>Status</th></tr>";
        data.forEach(item => {
            html += `<tr>
            <td><input type="checkbox" value="${Number(item.rowIndex)}" onchange="toggleRow(this)"></td>
            <td>${item.serial}</td>
            <td>${item.caseId}</td>
            <td>${item.status}</td>
            </tr>`;
        });
        html += "</table>";
        resultArea.innerHTML = html;
        btn.disabled = false;
        btn.innerText = "Search";
    }).catch(()=>{ alert("Error while searching"); btn.disabled = false; btn.innerText = "Search"; });
}

// Toggle row selection
function toggleRow(cb){
    let value = Number(cb.value);
    if(cb.checked){ if(!selectedRows.includes(value)) selectedRows.push(value); }
    else{ selectedRows = selectedRows.filter(r => r !== value); }
}

// ================= RECEIVE =================
function submitReceive(){
    let btn = document.getElementById("receiveBtn");
    btn.disabled = true;
    btn.innerText = "Processing...";

    let requiredFields = [
        receivedDatePostRepair,
        receiveDocket,
        receiveCourier
    ];

    let isValid = true;

    requiredFields.forEach(field=>{
        if(!validateField(field)) isValid = false;
        clearErrorOnInput(field);
    });

    if(selectedRows.length === 0){
        alert("Please select at least one serial");
        resetReceiveBtn();
        return;
    }

    if(!isValid){
        alert("Please fill all required fields");
        resetReceiveBtn();
        return;
    }

    fetch(WEB_APP_URL,{
        method:"POST",
        body: JSON.stringify({
            type: "receive",
            selectedRows: selectedRows,
            receivedDatePostRepair: receivedDatePostRepair.value,
            receiveDocket: receiveDocket.value,
            receiveCourier: receiveCourier.value
        })
    }).then(res=>res.json())
      .then(()=>{
          alert("Updated Successfully");
          location.reload();
      })
      .catch(()=>{
          alert("Something went wrong");
          resetReceiveBtn();
      });
}

// ================= DISPATCH SUBMIT =================
function submitDispatch(){
    let btn = document.getElementById("dispatchBtn");
    btn.disabled = true;
    btn.innerText = "Processing...";

    let requiredFields = [
        region, make, model,
        locationName, facilityEntity,
        receivedMailSubject, receivedDate,
        dispatchMailSubject, dispatchDocket,
        dispatchDate, dispatchCourier
    ];

    let isValid = true;

    requiredFields.forEach(field => {
        if(!validateField(field)) isValid = false;
        clearErrorOnInput(field);
    });

    // Validate serial numbers
    let serials = [];
    let s = document.getElementsByClassName("serial");
    let p = document.getElementsByClassName("problem");

    if(s.length === 0){
        alert("Add at least one serial number");
        resetDispatchBtn();
        return;
    }

    for(let i=0;i<s.length;i++){
        if(!validateField(s[i])) isValid = false;
        if(!validateField(p[i])) isValid = false;

        clearErrorOnInput(s[i]);
        clearErrorOnInput(p[i]);

        serials.push({serialNumber:s[i].value, problem:p[i].value});
    }

    // Validate RMA for Newland
    let caseIdToSend = "";
    if(make.value === "Newland"){
        if(!validateField(caseId)){
            isValid = false;
        }
        clearErrorOnInput(caseId);
        caseIdToSend = caseId.value.trim();
    }

    if(!isValid){
        alert("Please fill all required fields");
        resetDispatchBtn();
        return;
    }

    fetch(WEB_APP_URL,{
        method:"POST",
        body: JSON.stringify({
            type:"dispatch",
            region: region.value,
            make: make.value,
            model: model.value,
            locationName: locationName.value,
            facilityEntity: facilityEntity.value,
            receivedMailSubject: receivedMailSubject.value,
            receivedDate: receivedDate.value,
            dispatchMailSubject: dispatchMailSubject.value,
            dispatchDocket: dispatchDocket.value,
            dispatchDate: dispatchDate.value,
            dispatchCourier: dispatchCourier.value,
            serials: serials,
            caseId: caseIdToSend
        })
    }).then(res=>res.json())
      .then(res=>{
          alert("Case Created: "+res.caseId);
          location.reload();
      })
      .catch(()=>{
          alert("Something went wrong");
          resetDispatchBtn();
      });
}

function resetDispatchBtn(){
    let btn = document.getElementById("dispatchBtn");
    btn.disabled=false;
    btn.innerText="Submit Dispatch Details";
}

</script>

</body>
</html>
